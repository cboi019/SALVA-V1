<!DOCTYPE html>
<html lang="en">

<head>
Â  <meta charset="UTF-8">
Â  <meta name="viewport" content="width=device-width, initial-scale=1.0">
Â  <title>Salva V1 Protocol</title>

Â  <script src="https://cdn.tailwindcss.com"></script>

Â  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
Â  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
Â  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

Â  <script src="https://cdn.jsdelivr.net/npm/ethers@6.7.0/dist/ethers.umd.min.js"></script>

Â  <script type="text/babel">
Â  Â  // ====================================================================
Â  Â  // --- 1. CONFIGURATION & ABIs ---
Â  Â  // ====================================================================

Â  Â  const { useState, useEffect, useCallback, useMemo } = React;
Â  Â  const { ethers } = window;

Â  Â  const OWNER_ADDRESS = "0x708657da3e4effa7334779c9a1e759dc38a5bf94";
Â  Â  const CONTRACT_ADDRESS = "0xB87E5B544A78731Cb2a6F384f10adf51c29899a4";
Â  Â  
Â  Â  // --- CONTACT INFO ADDED ---
Â  Â  const CONTACT_EMAIL = "charlieonyii42@gmail.com";
Â  Â  const CONTACT_X = "https://x.com/cboi019";
Â  Â  // --------------------------


Â  Â  const CONTRACT_ABI = [
Â  Â  Â  // ... Your full ABI here ...
Â  Â  Â  { "inputs": [], "stateMutability": "nonpayable", "type": "constructor" },
Â  Â  Â  { "inputs": [{ "internalType": "address", "name": "_tokenAddress", "type": "address" }, { "internalType": "string", "name": "_name", "type": "string" }, { "internalType": "bool", "name": "_isAllowed", "type": "bool" }], "name": "addOrRemoveToken", "outputs": [], "stateMutability": "nonpayable", "type": "function" },
Â  Â  Â  { "inputs": [], "name": "getOwner", "outputs": [{ "internalType": "address", "name": "", "type": "address" }], "stateMutability": "view", "type": "function" },
Â  Â  Â  { "inputs": [{ "internalType": "address", "name": "_token", "type": "address" }, { "internalType": "string", "name": "_description", "type": "string" }, { "internalType": "uint256", "name": "_savingsDuration", "internalType": "uint256" }], "name": "createTimeBasedPlan", "outputs": [], "stateMutability": "nonpayable", "type": "function" },
Â  Â  Â  { "inputs": [{ "internalType": "address", "name": "_token", "type": "address" }, { "internalType": "string", "name": "_description", "type": "string" }, { "internalType": "uint256", "name": "_targetAmount", "type": "uint256" }], "name": "createGoalBasedPlan", "outputs": [], "stateMutability": "nonpayable", "type": "function" },
Â  Â  Â  { "inputs": [{ "internalType": "uint256", "name": "_id", "internalType": "uint256" }, { "internalType": "uint256", "name": "_amount", "internalType": "uint256" }], "name": "withdrawFromTBS", "outputs": [], "stateMutability": "nonpayable", "type": "function" },
Â  Â  Â  { "inputs": [{ "internalType": "uint256", "name": "_id", "internalType": "uint256" }, { "internalType": "uint256", "name": "_amount", "internalType": "uint256" }], "name": "withdrawFromGBS", "outputs": [], "stateMutability": "nonpayable", "type": "function" },
Â  Â  Â  { "inputs": [{ "internalType": "address", "name": "_user", "type": "address" }, { "internalType": "uint256", "name": "_id", "internalType": "uint256" }], "name": "viewTimeBasedPlan", "outputs": [{ "components": [{ "internalType": "address", "name": "user", "type": "address" }, { "internalType": "address", "name": "token", "type": "address" }, { "internalType": "string", "name": "description", "internalType": "string" }, { "internalType": "uint256", "name": "currentAmount", "internalType": "uint256" }, { "internalType": "uint256", "name": "startTime", "internalType": "uint256" }, { "internalType": "uint256", "name": "maturityTime", "internalType": "uint256" }, { "internalType": "bool", "name": "isComplete", "internalType": "bool" }], "internalType": "struct SalvaBase.TimeBasedCommitment", "name": "", "type": "tuple" }], "stateMutability": "view", "type": "function" },
Â  Â  Â  { "inputs": [{ "internalType": "address", "name": "_user", "type": "address" }, { "internalType": "uint256", "name": "_id", "internalType": "uint256" }], "name": "viewGoalBasedPlan", "outputs": [{ "components": [{ "internalType": "address", "name": "user", "type": "address" }, { "internalType": "address", "name": "token", "type": "address" }, { "internalType": "string", "name": "description", "internalType": "string" }, { "internalType": "uint256", "name": "currentAmount", "internalType": "uint256" }, { "internalType": "uint256", "name": "targetAmount", "internalType": "uint256" }, { "internalType": "bool", "name": "isComplete", "internalType": "bool" }], "internalType": "struct SalvaBase.GoalBasedSavings", "name": "", "type": "tuple" }], "stateMutability": "view", "type": "function" },
Â  Â  Â  // Add other functions and errors here...
Â  Â  ];

Â  Â  // --- Mock Data & Helpers ---
Â  Â  const shortenAddress = (addr) => `${addr.slice(0, 6)}...${addr.slice(-4)}`;
Â  Â  const formatTokenAmount = (amount, decimals = 18) => ethers.formatUnits(amount, decimals);
Â  Â  const formatTimestamp = (timestamp) => new Date(Number(timestamp) * 1000).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });

Â  Â  // ====================================================================
Â  Â  // --- 2. CONTEXT & WEB3 STATE MANAGEMENT ---
Â  Â  // ====================================================================

Â  Â  const Web3Context = React.createContext();

Â  Â  const Web3Provider = ({ children }) => {
Â  Â  Â  const [account, setAccount] = useState(null);
Â  Â  Â  const [signer, setSigner] = useState(null);
Â  Â  Â  const [salvaContract, setSalvaContract] = useState(null);
Â  Â  Â  const [owner, setOwner] = useState(null);
Â  Â  Â  const [loading, setLoading] = useState(false);
Â  Â  Â  const [error, setError] = useState(null);
Â  Â  Â  const [tokenCache, setTokenCache] = useState({}); // NEW STATE FOR DYNAMIC TOKEN CACHE

Â  Â  Â  const connectWallet = useCallback(async () => {
Â  Â  Â  Â  if (!window.ethereum) {
Â  Â  Â  Â  Â  setError("Please install MetaMask or another Web3 wallet.");
Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }
Â  Â  Â  Â  setLoading(true);
Â  Â  Â  Â  setError(null);
Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  const provider = new ethers.BrowserProvider(window.ethereum);
Â  Â  Â  Â  Â  const newSigner = await provider.getSigner();
Â  Â  Â  Â  Â  const newAccount = await newSigner.getAddress();

Â  Â  Â  Â  Â  const contractInstance = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, newSigner);

Â  Â  Â  Â  Â  setSigner(newSigner);
Â  Â  Â  Â  Â  setAccount(newAccount);
Â  Â  Â  Â  Â  setSalvaContract(contractInstance);

Â  Â  Â  Â  Â  const contractOwner = await contractInstance.getOwner();
Â  Â  Â  Â  Â  setOwner(contractOwner);

Â  Â  Â  Â  Â  // Add listener for account changes
Â  Â  Â  Â  Â  window.ethereum.on('accountsChanged', (accounts) => {
Â  Â  Â  Â  Â  Â  if (accounts.length > 0) {
Â  Â  Â  Â  Â  Â  Â  connectWallet(); // Reconnect on account change
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  setAccount(null);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  });

Â  Â  Â  Â  } catch (err) {
Â  Â  Â  Â  Â  console.error("Connection error:", err);
Â  Â  Â  Â  Â  setError("Failed to connect wallet.");
Â  Â  Â  Â  } finally {
Â  Â  Â  Â  Â  setLoading(false);
Â  Â  Â  Â  }
Â  Â  Â  }, []);

Â  Â  Â  useEffect(() => {
Â  Â  Â  Â  // Only auto-connect if user was previously connected
Â  Â  Â  Â  const checkConnection = async () => {
Â  Â  Â  Â  Â  if (window.ethereum) {
Â  Â  Â  Â  Â  Â  const accounts = await window.ethereum.request({ method: 'eth_accounts' });
Â  Â  Â  Â  Â  Â  if (accounts.length > 0) {
Â  Â  Â  Â  Â  Â  Â  connectWallet(); // Silently reconnect
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  };
Â  Â  Â  Â  checkConnection();
Â  Â  Â  }, []);

Â  Â  Â  return (
Â  Â  Â  Â  <Web3Context.Provider value={{ account, signer, salvaContract, owner, loading, error, connectWallet, tokenCache, setTokenCache }}>
Â  Â  Â  Â  Â  {children}
Â  Â  Â  Â  </Web3Context.Provider>
Â  Â  Â  );
Â  Â  };

Â  Â  const useWeb3 = () => React.useContext(Web3Context);

Â  Â  // --- Custom Hook to handle Token Data ---
Â  Â  // This simulates fetching token symbol/decimals from the underlying ERC20 contract
Â  Â  const useTokenData = () => {
Â  Â  Â  const { tokenCache, setTokenCache, salvaContract } = useWeb3();

Â  Â  Â  const fetchTokenDetails = useCallback(async (addr) => {
Â  Â  Â  Â  const normalizedAddr = addr.toLowerCase();
Â  Â  Â  Â  if (tokenCache[normalizedAddr]) return tokenCache[normalizedAddr];

Â  Â  Â  Â  // --- DANGER: SIMPLIFIED MOCKING FOR DEMO ---
Â  Â  Â  Â  // In a real app, you must connect to the ERC20 contract at `addr`
Â  Â  Â  Â  // and call methods like `symbol()` and `decimals()`.

Â  Â  Â  Â  const newDetails = {
Â  Â  Â  Â  Â  symbol: 'UNK', // Default to Unknown
Â  Â  Â  Â  Â  decimals: 18, // Default to 18 (common)
Â  Â  Â  Â  Â  name: 'Unknown Token'
Â  Â  Â  Â  };

Â  Â  Â  Â  // Example of how a real implementation might look:
Â  Â  Â  Â  // try {
Â  Â  Â  Â  //Â  Â  Â const provider = salvaContract.runner.provider;
Â  Â  Â  Â  //Â  Â  Â const tokenContract = new ethers.Contract(addr, ERC20_ABI_MINIMAL, provider);
Â  Â  Â  Â  //Â  Â  Â newDetails.symbol = await tokenContract.symbol();
Â  Â  Â  Â  //Â  Â  Â newDetails.decimals = await tokenContract.decimals();
Â  Â  Â  Â  // } catch (e) {
Â  Â  Â  Â  //Â  Â  Â console.warn(`Could not fetch details for token ${addr}`, e);
Â  Â  Â  Â  // }

Â  Â  Â  Â  setTokenCache(prev => ({ ...prev, [normalizedAddr]: newDetails }));
Â  Â  Â  Â  return newDetails;
Â  Â  Â  }, [tokenCache, setTokenCache, salvaContract]);

Â  Â  Â  return { tokenCache, fetchTokenDetails };
Â  Â  };

Â  Â  // ====================================================================
Â  Â  // --- 3. COMPONENTS ---
Â  Â  // ====================================================================

Â  Â  const WalletButton = () => {
Â  Â  Â  const { account, connectWallet, loading } = useWeb3();
Â  Â  Â  const bgColor = account ? "bg-green-500 hover:bg-green-600" : "bg-indigo-600 hover:bg-indigo-700";

Â  Â  Â  return (
Â  Â  Â  Â  <button
Â  Â  Â  Â  Â  onClick={connectWallet}
Â  Â  Â  Â  Â  disabled={loading}
Â  Â  Â  Â  Â  className={`px-4 py-2 text-sm font-medium text-white rounded-lg transition ${bgColor}`}
Â  Â  Â  Â  >
Â  Â  Â  Â  Â  {loading ? "Connecting..." : (account ? shortenAddress(account) : "Connect Wallet")}
Â  Â  Â  Â  </button>
Â  Â  Â  );
Â  Â  };

Â  Â  const Header = ({ navigate }) => {
Â  Â  Â  const { account } = useWeb3();
Â  Â  Â  return (
Â  Â  Â  Â  <header className="flex justify-between items-center p-4 border-b border-gray-200">
Â  Â  Â  Â  Â  <div className="text-2xl font-bold">
Â  Â  Â  Â  Â  Â  <span className="text-indigo-600">Salva</span>
Â  Â  Â  Â  Â  Â  <span className="text-green-500">V1</span>
Â  Â  Â  Â  Â  Â  Dashboard
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  <nav className="flex space-x-4 items-center">
Â  Â  Â  Â  Â  Â  <button onClick={() => navigate('/')} className="text-gray-600 hover:text-indigo-600">Home</button>
Â  Â  Â  Â  Â  Â  {account && <button onClick={() => navigate('/dashboard')} className="text-gray-600 hover:text-indigo-600">Dashboard</button>}
Â  Â  Â  Â  Â  Â  {account && <button onClick={() => navigate('/admin')} className="text-gray-600 hover:text-indigo-600">Admin</button>}
Â  Â  Â  Â  Â  Â  <WalletButton />
Â  Â  Â  Â  Â  </nav>
Â  Â  Â  Â  </header>
Â  Â  Â  );
Â  Â  };

Â  Â  // --- DASHBOARD COMPONENTS ---

Â  Â  const DashboardPlan = ({ plan, type }) => {
Â  Â  Â  const { salvaContract, account } = useWeb3();
Â  Â  Â  const { fetchTokenDetails } = useTokenData(); // Using the dynamic hook
Â  Â  Â  const [tokenSymbol, setTokenSymbol] = useState('...'); // Start with loading state

Â  Â  Â  const isTimeBased = type === 'TimeBased';
Â  Â  Â  const statusColor = plan.isComplete ? 'bg-green-500' : (isTimeBased && (Number(plan.maturityTime) * 1000) < Date.now() ? 'bg-green-500' : 'bg-indigo-500');
Â  Â  Â  const statusText = plan.isComplete || (isTimeBased && (Number(plan.maturityTime) * 1000) < Date.now()) ? 'Ready' : 'Active';
Â  Â  Â  const progress = isTimeBased
Â  Â  Â  Â  ? '100%'
Â  Â  Â  Â  : `${Math.min(100, (Number(plan.currentAmount) * 100) / Number(plan.targetAmount)).toFixed(2)}%`;

Â  Â  Â  useEffect(() => {
Â  Â  Â  Â  fetchTokenDetails(plan.token).then(data => {
Â  Â  Â  Â  Â  setTokenSymbol(data.symbol);
Â  Â  Â  Â  });
Â  Â  Â  }, [plan.token, fetchTokenDetails]);


Â  Â  Â  const handleWithdraw = async () => {
Â  Â  Â  Â  if (!salvaContract) return alert("Wallet not connected.");
Â  Â  Â  Â  const amount = prompt(`Enter amount to withdraw (in token units, e.g., 100 for 100 tokens):`);
Â  Â  Â  Â  if (!amount) return;

Â  Â  Â  Â  // NOTE: This assumes 18 decimals for simplicity; adjust for real tokens
Â  Â  Â  Â  const amountInWei = ethers.parseUnits(amount, 18);

Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  let tx;
Â  Â  Â  Â  Â  if (isTimeBased) {
Â  Â  Â  Â  Â  Â  tx = await salvaContract.withdrawFromTBS(plan.id, amountInWei);
Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  tx = await salvaContract.withdrawFromGBS(plan.id, amountInWei);
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  alert(`Withdrawal sent: ${tx.hash}. Wait for confirmation.`);
Â  Â  Â  Â  Â  await tx.wait();
Â  Â  Â  Â  Â  alert("Withdrawal successful! Refresh to see balance change.");
Â  Â  Â  Â  Â  // In a real app, you'd trigger a data refresh here.
Â  Â  Â  Â  } catch (err) {
Â  Â  Â  Â  Â  alert(`Withdrawal failed: ${err.reason || err.message}`);
Â  Â  Â  Â  Â  console.error(err);
Â  Â  Â  Â  }
Â  Â  Â  };

Â  Â  Â  return (
Â  Â  Â  Â  <div className="p-4 border rounded-lg shadow-sm mb-4 bg-white">
Â  Â  Â  Â  Â  <div className="flex justify-between items-center">
Â  Â  Â  Â  Â  Â  <p className="text-xl font-semibold">{formatTokenAmount(plan.currentAmount)} {tokenSymbol}</p>
Â  Â  Â  Â  Â  Â  <span className={`px-3 py-1 text-xs font-bold text-white rounded-full ${statusColor}`}>{statusText}</span>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  <p className="text-sm text-gray-500 mt-1">{plan.description}</p>
Â  Â  Â  Â  Â  <div className="w-full bg-gray-200 rounded-full h-2.5 mt-2">
Â  Â  Â  Â  Â  Â  <div
Â  Â  Â  Â  Â  Â  Â  className={`h-2.5 rounded-full ${plan.isComplete ? 'bg-green-500' : 'bg-indigo-500'}`}
Â  Â  Â  Â  Â  Â  Â  style={{ width: progress }}
Â  Â  Â  Â  Â  Â  ></div>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  <p className="text-xs text-gray-500 mt-1">
Â  Â  Â  Â  Â  Â  {isTimeBased ? `Maturity: ${formatTimestamp(plan.maturityTime)}` : `Goal: ${formatTokenAmount(plan.targetAmount)} ${tokenSymbol} (${progress})`}
Â  Â  Â  Â  Â  </p>
Â  Â  Â  Â  Â  {statusText === 'Ready' && (
Â  Â  Â  Â  Â  Â  <button
Â  Â  Â  Â  Â  Â  Â  onClick={handleWithdraw}
Â  Â  Â  Â  Â  Â  Â  className="mt-3 px-4 py-2 text-sm bg-green-600 hover:bg-green-700 text-white rounded-lg"
Â  Â  Â  Â  Â  Â  >
Â  Â  Â  Â  Â  Â  Â  Withdraw
Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  )}
Â  Â  Â  Â  </div>
Â  Â  Â  );
Â  Â  };

Â  Â  const DashboardPlans = () => {
Â  Â  Â  const { salvaContract, account } = useWeb3();
Â  Â  Â  const { tokenCache } = useTokenData();
Â  Â  Â  const [timePlans, setTimePlans] = useState([]);
Â  Â  Â  const [goalPlans, setGoalPlans] = useState([]);
Â  Â  Â  const [activeTab, setActiveTab] = useState('TimeBased');
Â  Â  Â  const [loadingPlans, setLoadingPlans] = useState(true);

Â  Â  Â  // Fetching logic is complex without a getter for all plan IDs,
Â  Â  Â  // so we'll use a simplified mock fetching or assume plan IDs 1-5 exist for demo.
Â  Â  Â  const fetchPlans = useCallback(async () => {
Â  Â  Â  Â  if (!salvaContract || !account) return;
Â  Â  Â  Â  setLoadingPlans(true);

Â  Â  Â  Â  // --- DANGER: SIMPLIFIED DEMO LOGIC ---
Â  Â  Â  Â  // In a real app, you need a backend service or a contract getter
Â  Â  Â  Â  // that returns ALL plan IDs associated with the user.
Â  Â  Â  Â  const potentialPlanIDs = [1, 2, 3, 4, 5];
Â  Â  Â  Â  const fetchedTime = [];
Â  Â  Â  Â  const fetchedGoal = [];

Â  Â  Â  Â  for (const id of potentialPlanIDs) {
Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  const timePlan = await salvaContract.viewTimeBasedPlan(account, id);
Â  Â  Â  Â  Â  Â  if (Number(timePlan.currentAmount) > 0) {
Â  Â  Â  Â  Â  Â  Â  fetchedTime.push({ ...timePlan, id: id });
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  } catch (e) { /* ignore empty slot */ }

Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  const goalPlan = await salvaContract.viewGoalBasedPlan(account, id);
Â  Â  Â  Â  Â  Â  if (Number(goalPlan.currentAmount) > 0) {
Â  Â  Â  Â  Â  Â  Â  fetchedGoal.push({ ...goalPlan, id: id });
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  } catch (e) { /* ignore empty slot */ }
Â  Â  Â  Â  }

Â  Â  Â  Â  setTimePlans(fetchedTime);
Â  Â  Â  Â  setGoalPlans(fetchedGoal);
Â  Â  Â  Â  setLoadingPlans(false);
Â  Â  Â  }, [salvaContract, account]);

Â  Â  Â  useEffect(() => {
Â  Â  Â  Â  fetchPlans();
Â  Â  Â  }, [fetchPlans]);

Â  Â  Â  const totalBalance = useMemo(() => {
Â  Â  Â  Â  // Total balance is accumulated across ALL token types in the plans
Â  Â  Â  Â  const total = [...timePlans, ...goalPlans].reduce((sum, plan) => {
Â  Â  Â  Â  Â  return sum + BigInt(plan.currentAmount);
Â  Â  Â  Â  }, BigInt(0));

Â  Â  Â  Â  // NOTE: This sum is a raw BigInt number. Since we can't reliably convert it
Â  Â  Â  Â  // to a single USD or token value without knowing the price and decimals of ALL
Â  Â  Â  Â  // mixed tokens, we display it as a generic, large token amount.
Â  Â  Â  Â  return formatTokenAmount(total);
Â  Â  Â  }, [timePlans, goalPlans]);


Â  Â  Â  const ActivePlans = activeTab === 'TimeBased' ? timePlans : goalPlans;

Â  Â  Â  return (
Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  <div className="bg-white p-6 rounded-lg shadow mb-6">
Â  Â  Â  Â  Â  Â  <h2 className="text-xl font-semibold text-gray-700">Total Locked Balance (Accumulated Value)</h2>
Â  Â  Â  Â  Â  Â  <p className="text-5xl font-extrabold text-indigo-700 mt-1">{totalBalance}</p>
Â  Â  Â  Â  Â  Â  <p className="text-sm text-gray-500 mt-2">Active Commitments: {timePlans.length + goalPlans.length}</p>
Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  <div className="flex mb-4 border-b border-gray-300">
Â  Â  Â  Â  Â  Â  <button
Â  Â  Â  Â  Â  Â  Â  onClick={() => setActiveTab('TimeBased')}
Â  Â  Â  Â  Â  Â  Â  className={`p-3 font-medium ${activeTab === 'TimeBased' ? 'border-b-2 border-indigo-600 text-indigo-600' : 'text-gray-500 hover:text-indigo-600'}`}
Â  Â  Â  Â  Â  Â  >
Â  Â  Â  Â  Â  Â  Â  Time-Based ({timePlans.length})
Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  <button
Â  Â  Â  Â  Â  Â  Â  onClick={() => setActiveTab('GoalBased')}
Â  Â  Â  Â  Â  Â  Â  className={`p-3 font-medium ${activeTab === 'GoalBased' ? 'border-b-2 border-green-600 text-green-600' : 'text-gray-500 hover:text-green-600'}`}
Â  Â  Â  Â  Â  Â  >
Â  Â  Â  Â  Â  Â  Â  Goal-Based ({goalPlans.length})
Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  {loadingPlans && <p className="text-center text-gray-500">Loading commitments...</p>}

Â  Â  Â  Â  Â  {!loadingPlans && ActivePlans.length === 0 && (
Â  Â  Â  Â  Â  Â  <p className="text-center p-10 border border-dashed rounded-lg text-gray-500">No active {activeTab} plans. Create one below!</p>
Â  Â  Â  Â  Â  )}

Â  Â  Â  Â  Â  {!loadingPlans && ActivePlans.map((plan, index) => (
Â  Â  Â  Â  Â  Â  <DashboardPlan key={index} plan={plan} type={activeTab} />
Â  Â  Â  Â  Â  ))}

Â  Â  Â  Â  Â  <CreatePlanModule fetchPlans={fetchPlans} />

Â  Â  Â  Â  </div>
Â  Â  Â  );
Â  Â  };

Â  Â  const CreatePlanModule = ({ fetchPlans }) => {
Â  Â  Â  const { salvaContract, account } = useWeb3();
Â  Â  Â  const [planType, setPlanType] = useState('TimeBased');
Â  Â  Â  const [token, setToken] = useState('');
Â  Â  Â  const [description, setDescription] = useState('');
Â  Â  Â  const [duration, setDuration] = useState('');
Â  Â  Â  const [targetAmount, setTargetAmount] = useState('');
Â  Â  Â  const [isCreating, setIsCreating] = useState(false);

Â  Â  Â  const handleCreate = async () => {
Â  Â  Â  Â  if (!salvaContract || !account || !token || !description) return alert("Fill all fields.");
Â  Â  Â  Â  if (planType === 'TimeBased' && !duration) return alert("Enter duration.");
Â  Â  Â  Â  if (planType === 'GoalBased' && !targetAmount) return alert("Enter target amount.");

Â  Â  Â  Â  setIsCreating(true);

Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  let tx;
Â  Â  Â  Â  Â  if (planType === 'TimeBased') {
Â  Â  Â  Â  Â  Â  const durationSeconds = BigInt(duration) * BigInt(60 * 60 * 24); // Days to seconds
Â  Â  Â  Â  Â  Â  tx = await salvaContract.createTimeBasedPlan(token, description, durationSeconds);
Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  // NOTE: Target amount assumes 18 decimals for simplicity!
Â  Â  Â  Â  Â  Â  const targetInWei = ethers.parseUnits(targetAmount, 18);
Â  Â  Â  Â  Â  Â  tx = await salvaContract.createGoalBasedPlan(token, description, targetInWei);
Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  alert(`Plan creation sent: ${tx.hash}. Waiting for confirmation.`);
Â  Â  Â  Â  Â  await tx.wait();
Â  Â  Â  Â  Â  alert("Plan created successfully! You can now fund it.");
Â  Â  Â  Â  Â  fetchPlans(); // Refresh dashboard
Â  Â  Â  Â  } catch (err) {
Â  Â  Â  Â  Â  alert(`Creation failed: ${err.reason || err.message}`);
Â  Â  Â  Â  Â  console.error(err);
Â  Â  Â  Â  } finally {
Â  Â  Â  Â  Â  setIsCreating(false);
Â  Â  Â  Â  }
Â  Â  Â  };

Â  Â  Â  return (
Â  Â  Â  Â  <div className="mt-8 p-6 bg-white rounded-lg shadow-xl">
Â  Â  Â  Â  Â  <h3 className="text-2xl font-bold mb-4">Create New Commitment</h3>

Â  Â  Â  Â  Â  <div className="flex space-x-4 mb-4">
Â  Â  Â  Â  Â  Â  <button
Â  Â  Â  Â  Â  Â  Â  onClick={() => setPlanType('TimeBased')}
Â  Â  Â  Â  Â  Â  Â  className={`px-6 py-2 rounded-lg font-medium ${planType === 'TimeBased' ? 'bg-indigo-600 text-white' : 'bg-gray-200 text-gray-800'}`}
Â  Â  Â  Â  Â  Â  >
Â  Â  Â  Â  Â  Â  Â  Time-Based
Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  <button
Â  Â  Â  Â  Â  Â  Â  onClick={() => setPlanType('GoalBased')}
Â  Â  Â  Â  Â  Â  Â  className={`px-6 py-2 rounded-lg font-medium ${planType === 'GoalBased' ? 'bg-green-600 text-white' : 'bg-gray-200 text-gray-800'}`}
Â  Â  Â  Â  Â  Â  >
Â  Â  Â  Â  Â  Â  Â  Goal-Based
Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  <input className="w-full p-3 border rounded mb-3" placeholder="Token Address (must be whitelisted)" value={token} onChange={e => setToken(e.target.value)} />
Â  Â  Â  Â  Â  <input className="w-full p-3 border rounded mb-3" placeholder="Description (e.g., 'Vacation Fund')" value={description} onChange={e => setDescription(e.target.value)} />

Â  Â  Â  Â  Â  {planType === 'TimeBased' ? (
Â  Â  Â  Â  Â  Â  <input className="w-full p-3 border rounded mb-3" type="number" placeholder="Lock Duration (in Days)" value={duration} onChange={e => setDuration(e.target.value)} />
Â  Â  Â  Â  Â  ) : (
Â  Â  Â  Â  Â  Â  <input className="w-full p-3 border rounded mb-3" type="number" placeholder="Target Amount (e.g., 500)" value={targetAmount} onChange={e => setTargetAmount(e.target.value)} />
Â  Â  Â  Â  Â  )}

Â  Â  Â  Â  Â  <button
Â  Â  Â  Â  Â  Â  onClick={handleCreate}
Â  Â  Â  Â  Â  Â  disabled={isCreating || !salvaContract}
Â  Â  Â  Â  Â  Â  className="w-full py-3 bg-indigo-600 hover:bg-indigo-700 text-white font-bold rounded-lg transition"
Â  Â  Â  Â  Â  >
Â  Â  Â  Â  Â  Â  {isCreating ? "Creating..." : "Create Commitment"}
Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  </div>
Â  Â  Â  )
Â  Â  }

Â  Â  // --- PAGE VIEWS ---

Â  Â  const HomePage = ({ navigate }) => (
Â  Â  Â  <div className="p-10 text-center">
Â  Â  Â  Â  <h2 className="text-6xl font-extrabold my-8">
Â  Â  Â  Â  Â  <span className="text-gray-900">Lock. Commit.</span>
Â  Â  Â  Â  Â  <span className="text-indigo-600"> Grow.</span>
Â  Â  Â  Â  </h2>
Â  Â  Â  Â  <p className="text-lg text-gray-600 max-w-2xl mx-auto">
Â  Â  Â  Â  Â  The trustless protocol for **self-enforced financial discipline** on-chain. Achieve your goals without relying on third-party custodians.
Â  Â  Â  Â  </p>
Â  Â  Â  Â  <button
Â  Â  Â  Â  Â  onClick={() => navigate('/dashboard')}
Â  Â  Â  Â  Â  className="mt-8 px-10 py-4 bg-indigo-600 hover:bg-indigo-700 text-white font-bold rounded-lg text-xl"
Â  Â  Â  Â  >
Â  Â  Â  Â  Â  Get Started
Â  Â  Â  Â  </button>

Â  Â  Â  Â  <div className="flex justify-center space-x-8 mt-16">
Â  Â  Â  Â  Â  {/* TimeLock Card */}
Â  Â  Â  Â  Â  <div className="w-1/3 p-6 border rounded-xl shadow-lg bg-white">
Â  Â  Â  Â  Â  Â  <div className="text-6xl mb-4">â°</div>
Â  Â  Â  Â  Â  Â  <h4 className="text-xl font-bold mb-2">TimeLock (Time-Based)</h4>
Â  Â  Â  Â  Â  Â  <p className="text-gray-600 text-sm">Lock a specific amount of tokens until a fixed block timestamp is reached. Perfect for vesting or long-term savings.</p>
Â  Â  Â  Â  Â  Â  <button onClick={() => navigate('/dashboard')} className="mt-4 px-6 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg">View Dashboard</button>
Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  {/* GoalLock Card */}
Â  Â  Â  Â  Â  <div className="w-1/3 p-6 border rounded-xl shadow-lg bg-white">
Â  Â  Â  Â  Â  Â  <div className="text-6xl mb-4">ğŸ¯</div>
Â  Â  Â  Â  Â  Â  <h4 className="text-xl font-bold mb-2">GoalLock (Goal-Based)</h4>
Â  Â  Â  Â  Â  Â  <p className="text-gray-600 text-sm">Assets are locked until a predefined smart contract condition (currentAmount greater than or equal to targetAmount) is met.</p>
Â  Â  Â  Â  Â  Â  <button onClick={() => navigate('/dashboard')} className="mt-4 px-6 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg">View Dashboard</button>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div className="mt-20">
Â  Â  Â  Â  Â  <h3 className="text-3xl font-bold mb-6">Security & Transparency First</h3>
Â  Â  Â  Â  Â  {/* Updated to only show the two remaining pillars, with adjusted spacing and width */}
Â  Â  Â  Â  Â  <div className="flex justify-center space-x-10"> 
Â  Â  Â  Â  Â  Â  <Pillar icon="BarChart" title="Zero Protocol Fees" description="Salva V1 is a public good protocol. It takes zero commission and has zero hidden fees on deposits or withdrawals (only gas applies)." width="w-2/5" />
Â  Â  Â  Â  Â  Â  <Pillar icon="Lock" title="Immutable Terms" description="Once a commitment is created, the terms (time or goal) cannot be changed or revoked by any party, including the protocol owner." width="w-2/5" />
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>
Â  Â  );

Â  Â  // Updated Pillar component to accept a width prop
Â  Â  const Pillar = ({ icon, title, description, width = "w-1/4" }) => {
Â  Â  Â  const icons = {
Â  Â  Â  Â  'Shield': 'ğŸ›¡ï¸',
Â  Â  Â  Â  'BarChart': 'ğŸ“Š',
Â  Â  Â  Â  'Lock': 'ğŸ”’'
Â  Â  Â  };

Â  Â  Â  return (
Â  Â  Â  Â  <div className={`${width} p-4 border rounded-lg shadow-sm bg-gray-50`}>
Â  Â  Â  Â  Â  <div className="text-4xl mb-2">{icons[icon]}</div>
Â  Â  Â  Â  Â  <h5 className="font-semibold">{title}</h5>
Â  Â  Â  Â  Â  <p className="text-sm text-gray-600">{description}</p>
Â  Â  Â  Â  </div>
Â  Â  Â  );
Â  Â  };

Â  Â  const DashboardPage = () => {
Â  Â  Â  const { account } = useWeb3();
Â  Â  Â  if (!account) return <div className="p-10 text-center text-red-500">Please connect your wallet to view the dashboard.</div>;
Â  Â  Â  return (
Â  Â  Â  Â  <div className="p-10 max-w-4xl mx-auto">
Â  Â  Â  Â  Â  <h2 className="text-3xl font-bold mb-6">My Commitments</h2>
Â  Â  Â  Â  Â  <DashboardPlans />
Â  Â  Â  Â  Â  <p className="mt-10 text-sm text-gray-500 text-center">
Â  Â  Â  Â  Â  Â  <span className="font-bold">NOTE:</span> Due to technical limitations of a single-file dApp, you must manually fund plans using a different interface (like Etherscan) or by implementing the 'Fund' buttons here.
Â  Â  Â  Â  Â  </p>
Â  Â  Â  Â  </div>
Â  Â  Â  );
Â  Â  };

Â  Â  const AdminPage = () => {
Â  Â  Â  const { salvaContract, account, owner } = useWeb3();
Â  Â  Â  const [token, setToken] = useState('');
Â  Â  Â  const [name, setName] = useState('');
Â  Â  Â  const [action, setAction] = useState(true); // true for Add, false for Remove
Â  Â  Â  const [loadingTx, setLoadingTx] = useState(false);
Â  Â  Â  const isAdmin = account && owner && account.toLowerCase() === owner.toLowerCase();

Â  Â  Â  if (!isAdmin) {
Â  Â  Â  Â  return <div className="p-10 text-center text-red-500">Access Denied. Only the contract owner ({owner ? shortenAddress(owner) : '...'}) can access this page.</div>;
Â  Â  Â  }

Â  Â  Â  const handleUpdateWhitelist = async () => {
Â  Â  Â  Â  if (!salvaContract || !token || !name) return alert("Fill all fields.");
Â  Â  Â  Â  setLoadingTx(true);
Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  const tx = await salvaContract.addOrRemoveToken(token, name, action);
Â  Â  Â  Â  Â  alert(`Transaction sent: ${tx.hash}. Waiting for confirmation.`);
Â  Â  Â  Â  Â  await tx.wait();
Â  Â  Â  Â  Â  alert(`Token successfully ${action ? 'ADDED' : 'REMOVED'} from whitelist.`);
Â  Â  Â  Â  } catch (err) {
Â  Â  Â  Â  Â  alert(`Transaction failed: ${err.reason || err.message}. Check console for details.`);
Â  Â  Â  Â  Â  console.error(err);
Â  Â  Â  Â  } finally {
Â  Â  Â  Â  Â  setLoadingTx(false);
Â  Â  Â  Â  }
Â  Â  Â  };

Â  Â  Â  return (
Â  Â  Â  Â  <div className="p-10 max-w-2xl mx-auto bg-white shadow-xl rounded-lg mt-10">
Â  Â  Â  Â  Â  <h2 className="text-3xl font-bold mb-6">Protocol Admin: Token Whitelist</h2>
Â  Â  Â  Â  Â  <p className="text-sm text-gray-600 mb-4">You are logged in as the contract owner: <span className="font-mono text-indigo-600">{shortenAddress(account)}</span></p>

Â  Â  Â  Â  Â  <div className="flex space-x-4 mb-4">
Â  Â  Â  Â  Â  Â  <button
Â  Â  Â  Â  Â  Â  Â  onClick={() => setAction(true)}
Â  Â  Â  Â  Â  Â  Â  className={`px-6 py-2 rounded-lg font-medium ${action ? 'bg-green-600 text-white' : 'bg-gray-200 text-gray-800'}`}
Â  Â  Â  Â  Â  Â  >
Â  Â  Â  Â  Â  Â  Â  Add Token
Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  <button
Â  Â  Â  Â  Â  Â  Â  onClick={() => setAction(false)}
Â  Â  Â  Â  Â  Â  Â  className={`px-6 py-2 rounded-lg font-medium ${!action ? 'bg-red-600 text-white' : 'bg-gray-200 text-gray-800'}`}
Â  Â  Â  Â  Â  Â  >
Â  Â  Â  Â  Â  Â  Â  Remove Token
Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  <input className="w-full p-3 border rounded mb-3" placeholder="Token Contract Address" value={token} onChange={e => setToken(e.target.value)} />
Â  Â  Â  Â  Â  <input className="w-full p-3 border rounded mb-5" placeholder="Token Name (for event logging)" value={name} onChange={e => setName(e.target.value)} />

Â  Â  Â  Â  Â  <button
Â  Â  Â  Â  Â  Â  onClick={handleUpdateWhitelist}
Â  Â  Â  Â  Â  Â  disabled={loadingTx || !salvaContract}
Â  Â  Â  Â  Â  Â  className={`w-full py-3 font-bold rounded-lg transition ${action ? 'bg-green-600 hover:bg-green-700' : 'bg-red-600 hover:bg-red-700'} text-white`}
Â  Â  Â  Â  Â  >
Â  Â  Â  Â  Â  Â  {loadingTx ? "Processing..." : `${action ? 'Whitelist' : 'Remove'} Token`}
Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  </div>
Â  Â  Â  );
Â  Â  };
Â  Â  
Â  Â  // --- NEW FOOTER COMPONENT ---
Â  Â  const Footer = () => (
Â  Â  Â  Â  <footer className="mt-16 py-6 border-t border-gray-200 bg-white">
Â  Â  Â  Â  Â  Â  <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 flex flex-col sm:flex-row justify-between items-center text-sm text-gray-500">
Â  Â  Â  Â  Â  Â  Â  Â  <p className="mb-2 sm:mb-0">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Salva V1 Protocol | Contract: {shortenAddress(CONTRACT_ADDRESS)}
Â  Â  Â  Â  Â  Â  Â  Â  </p>
Â  Â  Â  Â  Â  Â  Â  Â  <div className="flex flex-col sm:flex-row sm:space-x-4">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p className="font-semibold text-gray-700">Contact Owner:</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <a href={`mailto:${CONTACT_EMAIL}`} className="hover:text-indigo-600 transition">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Email: {CONTACT_EMAIL}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </a>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <a href={CONTACT_X} target="_blank" rel="noopener noreferrer" className="hover:text-indigo-600 transition">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  X: @cboi019
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </a>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </footer>
Â  Â  );

Â  Â  // --- ROOT APP & ROUTER ---
Â  Â  const App = () => {
Â  Â  Â  const [path, setPath] = useState(window.location.hash.substring(1) || '/');
Â  Â  Â  const navigate = (newPath) => {
Â  Â  Â  Â  window.location.hash = newPath;
Â  Â  Â  Â  setPath(newPath);
Â  Â  Â  };

Â  Â  Â  useEffect(() => {
Â  Â  Â  Â  const handleHashChange = () => setPath(window.location.hash.substring(1) || '/');
Â  Â  Â  Â  window.addEventListener('hashchange', handleHashChange);
Â  Â  Â  Â  return () => window.removeEventListener('hashchange', handleHashChange);
Â  Â  Â  }, []);

Â  Â  Â  let PageComponent;
Â  Â  Â  if (path === '/dashboard') {
Â  Â  Â  Â  PageComponent = DashboardPage;
Â  Â  Â  } else if (path === '/admin') {
Â  Â  Â  Â  PageComponent = AdminPage;
Â  Â  Â  } else {
Â  Â  Â  Â  PageComponent = HomePage;
Â  Â  Â  }

Â  Â  Â  return (
Â  Â  Â  Â  <div className="min-h-screen bg-gray-50">
Â  Â  Â  Â  Â  <Header navigate={navigate} />
Â  Â  Â  Â  Â  <main className="pb-16"> {/* Added padding to main to prevent footer overlap */}
Â  Â  Â  Â  Â  Â  <PageComponent navigate={navigate} />
Â  Â  Â  Â  Â  </main>
Â  Â  Â  Â  Â  Â  <Footer />
Â  Â  Â  Â  </div>
Â  Â  Â  );
Â  Â  };

Â  Â  // ====================================================================
Â  Â  // --- 4. RENDER APPLICATION (React 18 Compliant) ---
Â  Â  // ====================================================================
Â  Â  const container = document.getElementById('root');

Â  Â  // This is the new React 18 way to render an application
Â  Â  const root = ReactDOM.createRoot(container);
Â  Â  root.render(
Â  Â  Â  <Web3Provider>
Â  Â  Â  Â  <App />
Â  Â  Â  </Web3Provider>
Â  Â  );

Â  </script>
</head>

<body class="bg-gray-50">
Â  <div id="root"></div>
</body>

</html>